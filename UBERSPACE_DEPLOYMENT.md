# Uberspace Deployment Guide

This guide will help you deploy the day-care rotation system to your Uberspace server.

## Prerequisites

- Uberspace account on himalia.uberspace.de
- SSH access to your Uberspace server
- MariaDB database already set up on Uberspace
- Node.js installed on Uberspace (already available)

## Initial Setup (One-time)

### 1. SSH into your Uberspace server

```bash
ssh your_username@himalia.uberspace.de
```

### 2. Create the .env file for backend

```bash
cd ~/daycare-app/backend
nano .env
```

Add the following configuration (replace with your actual values):

```env
# Database Configuration
DB_HOST=localhost
DB_USER=your_uberspace_username
DB_PASSWORD=your_database_password
DB_NAME=your_uberspace_username_daycare
DB_PORT=3306

# JWT Secret (generate with: openssl rand -base64 32)
JWT_SECRET=your_generated_secret_here

# Email Configuration (optional but recommended)
EMAIL_HOST=himalia.uberspace.de
EMAIL_PORT=587
EMAIL_SECURE=true
EMAIL_USER=your_email@yourdomain.com
EMAIL_PASSWORD=your_email_password
EMAIL_FROM=Day-Care System <noreply@yourdomain.com>

# Application Configuration
NODE_ENV=production
PORT=5000
FRONTEND_URL=https://your_username.uber.space/daycare
```

**Generate JWT Secret:**
```bash
openssl rand -base64 32
```

### 3. Initialize the database

If you haven't already set up the database:

```bash
cd ~/daycare-app/backend

# Connect to MySQL
mysql

# Create database (if needed)
CREATE DATABASE your_username_daycare;
exit;

# Import schema
mysql your_username_daycare < database/schema.sql
```

### 4. Configure web backend

Set up the API endpoint to forward to your Node.js backend:

```bash
uberspace web backend set /api --http --port 5000
```

This makes your API available at `https://your_username.uber.space/api`

### 5. Configure domain (Optional)

If you have a custom domain:

```bash
# Add your domain
uberspace web domain add yourdomain.com
uberspace web domain add www.yourdomain.com

# SSL certificates are automatically generated by Uberspace
```

## Automated Deployment

### Using the deployment script

1. **On your local machine**, make the script executable:

```bash
chmod +x deploy-uberspace.sh
```

2. **Set your Uberspace username** (or you'll be prompted):

```bash
export UBERSPACE_USER=your_username
```

3. **Run the deployment**:

```bash
./deploy-uberspace.sh
```

The script will:
- Build the frontend
- Package backend files
- Upload everything to Uberspace
- Install dependencies
- Configure and restart the service

### What the script does

1. ✅ Builds React frontend with production settings
2. ✅ Uploads backend code to `~/daycare-app/backend/`
3. ✅ Uploads frontend build to `~/html/daycare/`
4. ✅ Installs Node.js dependencies on server
5. ✅ Creates supervisor configuration
6. ✅ Starts/restarts the backend service

## Manual Deployment (Alternative)

If you prefer to deploy manually:

### Step 1: Build Frontend

```bash
# On your local machine
cd frontend

# Create production environment file
cat > .env.production << EOF
REACT_APP_API_URL=https://your_username.uber.space/api
EOF

# Build
npm run build
```

### Step 2: Upload Frontend

```bash
# Upload to Uberspace
rsync -avz build/ your_username@himalia.uberspace.de:~/html/daycare/
```

### Step 3: Upload Backend

```bash
# On your local machine
cd backend

# Upload backend files
rsync -avz --exclude='node_modules' \
           --exclude='.env' \
           --exclude='coverage' \
           --exclude='__tests__' \
           ./ your_username@himalia.uberspace.de:~/daycare-app/backend/
```

### Step 4: Install & Configure on Server

```bash
# SSH into server
ssh your_username@himalia.uberspace.de

# Install dependencies
cd ~/daycare-app/backend
npm install --production

# Create .env file (see Initial Setup above)
nano .env

# Create supervisor config
nano ~/etc/services.d/daycare-backend.ini
```

Add to supervisor config:

```ini
[program:daycare-backend]
directory=%(ENV_HOME)s/daycare-app/backend
command=/usr/bin/node server.js
autorestart=true
stdout_logfile=%(ENV_HOME)s/logs/daycare-backend.log
stderr_logfile=%(ENV_HOME)s/logs/daycare-backend-error.log
```

### Step 5: Start Service

```bash
# Create logs directory
mkdir -p ~/logs

# Reload supervisor
supervisorctl reread
supervisorctl update

# Start the service
supervisorctl start daycare-backend

# Check status
supervisorctl status daycare-backend
```

## Post-Deployment

### Access Your Application

- Frontend: `https://your_username.uber.space/daycare/`
- API: `https://your_username.uber.space/api/`

Or with custom domain:
- Frontend: `https://yourdomain.com/daycare/`
- API: `https://yourdomain.com/api/`

### View Logs

```bash
# Backend logs
tail -f ~/logs/daycare-backend.log

# Error logs
tail -f ~/logs/daycare-backend-error.log

# Supervisor status
supervisorctl status daycare-backend
```

### Managing the Service

```bash
# Restart
supervisorctl restart daycare-backend

# Stop
supervisorctl stop daycare-backend

# Start
supervisorctl start daycare-backend

# View status
supervisorctl status
```

## Updating the Application

To deploy updates:

```bash
# On your local machine
./deploy-uberspace.sh
```

Or manually:
1. Build and upload new frontend
2. Upload new backend code
3. SSH into server and restart: `supervisorctl restart daycare-backend`

## Troubleshooting

### Backend won't start

```bash
# Check logs
tail -n 50 ~/logs/daycare-backend-error.log

# Check if port 5000 is in use
ss -tlnp | grep 5000

# Manually test backend
cd ~/daycare-app/backend
node server.js
```

### Database connection errors

```bash
# Test database connection
mysql

# Check .env file
cat ~/daycare-app/backend/.env

# Verify DB credentials match your Uberspace database
```

### Frontend shows API errors

1. Check CORS settings in backend
2. Verify `REACT_APP_API_URL` matches your actual API URL
3. Check that web backend is configured: `uberspace web backend list`

### 502 Bad Gateway

- Backend service is not running
- Check: `supervisorctl status daycare-backend`
- Restart: `supervisorctl restart daycare-backend`

### Changes not appearing

1. Clear browser cache
2. Verify files were uploaded: `ls -la ~/html/daycare/`
3. Check build date: `ls -la ~/html/daycare/index.html`

## Security Checklist

- [ ] Changed default staff password from `048204`
- [ ] Generated strong JWT_SECRET (32+ characters)
- [ ] Database credentials are secure
- [ ] .env file has restricted permissions: `chmod 600 ~/.env`
- [ ] Email credentials are configured
- [ ] HTTPS is enabled (automatic on Uberspace)
- [ ] Regular database backups are scheduled

## Database Backups

Create a backup script:

```bash
nano ~/bin/backup-daycare-db.sh
```

```bash
#!/bin/bash
BACKUP_DIR="$HOME/backups/daycare"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

mysqldump your_username_daycare > $BACKUP_DIR/daycare_${DATE}.sql
gzip $BACKUP_DIR/daycare_${DATE}.sql

# Keep only last 30 days
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

Make it executable and add to crontab:

```bash
chmod +x ~/bin/backup-daycare-db.sh

# Add to crontab (daily at 2 AM)
crontab -e
```

Add line:
```
0 2 * * * ~/bin/backup-daycare-db.sh
```

## Support

For Uberspace-specific issues:
- Manual: https://manual.uberspace.de/
- Support: https://uberspace.de/en/support/

For application issues:
- Check logs in `~/logs/`
- Review backend error logs
- Test API endpoints directly
